-- v1.0.0 - Cheong - 2015/05/07 - Add reference of SOURCEVIEWCOLUMN to REPORTCOLUMN and allow individual report column have custom column header
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT

BEGIN TRANSACTION
GO
ALTER TABLE dbo.REPORTCOLUMN ADD
	SOURCEVIEWCOLUMNID int NULL,
	DISPLAYNAME nvarchar(128) NULL
GO
ALTER TABLE dbo.REPORTCOLUMN SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

BEGIN TRANSACTION
GO
EXECUTE sp_rename N'dbo.REPORTCOLUMN.COLUMNTYPE', N'Tmp_COLUMNFUNC', 'COLUMN' 
GO
EXECUTE sp_rename N'dbo.REPORTCOLUMN.Tmp_COLUMNFUNC', N'COLUMNFUNC', 'COLUMN' 
GO
ALTER TABLE dbo.REPORTCOLUMN SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

BEGIN TRANSACTION

--v1.0.0 - Cheong - 2015/06/04 - updated script to fix duplicate report problem
--INSERT INTO SOURCEVIEWCOLUMN (SVID, COLUMNNAME, DISPLAYNAME, COLUMNTYPE, COLUMNCOMMENT, FORMULAFIELDID, HIDDEN, DEFAULTDISPLAYNAME)
--SELECT
--	r.SVID, rc.COLUMNNAME, '', 1, '', NULL, 0, ''
--FROM REPORTCOLUMN rc
--INNER JOIN REPORT r ON rc.RPID = r.ID

INSERT INTO SOURCEVIEWCOLUMN (SVID, COLUMNNAME, DISPLAYNAME, COLUMNTYPE, COLUMNCOMMENT, FORMULAFIELDID, HIDDEN, DEFAULTDISPLAYNAME)
SELECT
	r.SVID, rc.COLUMNNAME, '', 1, '', NULL, 0, ''
FROM REPORTCOLUMN rc
INNER JOIN REPORT r ON rc.RPID = r.ID
-- comment following line if not run 20150508 script
WHERE rc.COLUMNTYPE = 1
GROUP BY r.SVID, rc.COLUMNNAME

COMMIT
GO

BEGIN TRANSACTION

UPDATE REPORTCOLUMN SET SOURCEVIEWCOLUMNID = svc.ID, DISPLAYNAME = ''
FROM REPORTCOLUMN rc
INNER JOIN REPORT r ON rc.RPID = r.ID
INNER JOIN SOURCEVIEWCOLUMN svc ON svc.SVID = r.SVID AND rc.COLUMNNAME = svc.COLUMNNAME

COMMIT
GO

BEGIN TRANSACTION
GO
ALTER TABLE dbo.REPORTCOLUMN ALTER COLUMN SOURCEVIEWCOLUMNID int NOT NULL
GO
ALTER TABLE dbo.REPORTCOLUMN SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

ALTER VIEW [dbo].[V_REPORT]
AS
SELECT
	r.SVID, rc.ID AS RCID, rc.RPID, rc.COLUMNNAME,
	rc.COLUMNFUNC, rc.CRITERIA1, rc.CRITERIA2, rc.CRITERIA3,
	rc.CRITERIA4, r.REPORTNAME, sv.SOURCEVIEWNAME, r.CATEGORY
FROM dbo.SOURCEVIEW sv
INNER JOIN dbo.REPORT r ON sv.ID = r.SVID
INNER JOIN dbo.REPORTCOLUMN rc ON r.ID = rc.RPID
GO

-- v1.0.0 - Cheong - SET DEFAULTNAME FOR NGO (Run only if deploy to NGOs)
/*
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Service Unit' WHERE COLUMNNAME = 'Zone'
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Service Unit Code' WHERE COLUMNNAME = 'ZoneCode'
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Service Type' WHERE COLUMNNAME = 'Station'
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Service Type Code' WHERE COLUMNNAME = 'StationCode'

UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Service Unit', DISPLAYNAME = 'Service Unit' WHERE COLUMNNAME = 'Zone'
UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Service Unit Code', DISPLAYNAME = 'Service Unit Code' WHERE COLUMNNAME = 'ZoneCode'
UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Service Type', DISPLAYNAME = 'Service Type' WHERE COLUMNNAME = 'Station'
UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Service Type Code', DISPLAYNAME = 'Service Type Code' WHERE COLUMNNAME = 'StationCode'
*/

-- v1.0.0 - Cheong - SET DEFAULTNAME FOR COMMERCIAL (Run only if deploy to COMMERCIALs)
/*
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Department' WHERE COLUMNNAME = 'Zone'
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Department Code' WHERE COLUMNNAME = 'ZoneCode'
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Office' WHERE COLUMNNAME = 'Station'
UPDATE dbo.REPORTCOLUMN SET DISPLAYNAME = 'Office Code' WHERE COLUMNNAME = 'StationCode'

UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Department', DISPLAYNAME = 'Department' WHERE COLUMNNAME = 'Zone'
UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Department Code', DISPLAYNAME = 'Department Code' WHERE COLUMNNAME = 'ZoneCode'
UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Office', DISPLAYNAME = 'Office' WHERE COLUMNNAME = 'Station'
UPDATE dbo.SOURCEVIEWCOLUMN SET DEFAULTDISPLAYNAME = 'Office Code', DISPLAYNAME = 'Office Code' WHERE COLUMNNAME = 'StationCode'
*/