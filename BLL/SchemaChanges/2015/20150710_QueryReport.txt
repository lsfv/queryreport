--v1.0.0 - Cheong - 2015/07/10 - Add SEQ to REPORTCOLUMN
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON

IF ((SELECT COUNT(*) FROM sys.sysobjects o INNER JOIN sys.columns c ON o.id = c.object_id WHERE o.name = 'REPORTCOLUMN' AND c.name = 'SEQ') = 0)
BEGIN
	EXEC sp_executesql N'ALTER TABLE dbo.REPORTCOLUMN ADD SEQ int NULL'
	EXEC sp_executesql N'UPDATE REPORTCOLUMN
		SET SEQ = ISNULL(idx.SEQ, -1)
		FROM REPORTCOLUMN rc
		LEFT JOIN (
			SELECT ID, SEQ = row_number() OVER ( PARTITION BY RPID ORDER BY ID)
			FROM dbo.REPORTCOLUMN r
			WHERE COLUMNFUNC = 1
		) idx ON rc.ID = idx.ID'
	EXEC sp_executesql N'ALTER TABLE dbo.REPORTCOLUMN ALTER COLUMN SEQ int NOT NULL'
	EXEC sp_executesql N'ALTER TABLE dbo.REPORTCOLUMN SET (LOCK_ESCALATION = TABLE)'
END