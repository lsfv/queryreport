SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO
-- v1.0.0 - Cheong - drop unneeded table
IF EXISTS(SELECT * FROM [INFORMATION_SCHEMA].[TABLES] WHERE [TABLE_SCHEMA] = 'dbo' AND [TABLE_NAME] = 'KEYVALUE')
BEGIN
	DROP TABLE [dbo].[KEYVALUE]
END

-- v1.0.0 - Cheong - rename table to match parent table name
IF EXISTS(SELECT * FROM [INFORMATION_SCHEMA].[TABLES] WHERE [TABLE_SCHEMA] = 'dbo' AND [TABLE_NAME] = 'SELECTEDCOLUMN')
BEGIN
	EXEC sp_rename N'SELECTEDCOLUMN', 'REPORTCOLUMN'
END
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[REPORTCOLUMN]') AND name = N'PK_SELECTEDCOLUMN')
ALTER TABLE [dbo].[REPORTCOLUMN] DROP CONSTRAINT [PK_SELECTEDCOLUMN]
GO

IF  NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[REPORTCOLUMN]') AND name = N'PK_REPORTCOLUMN')
ALTER TABLE [dbo].[REPORTCOLUMN] ADD  CONSTRAINT [PK_REPORTCOLUMN] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

GO
ALTER VIEW [dbo].[V_REPORT]
AS
SELECT
	r.SVID, rc.ID AS RCID, rc.RPID, rc.COLUMNNAME,
	rc.COLUMNTYPE, rc.CRITERIA1, rc.CRITERIA2, rc.CRITERIA3,
	rc.CRITERIA4, r.REPORTNAME, sv.SOURCEVIEWNAME, r.CATEGORY
FROM dbo.SOURCEVIEW sv
INNER JOIN dbo.REPORT r ON sv.ID = r.SVID
INNER JOIN dbo.REPORTCOLUMN rc ON r.ID = rc.RPID
GO

ALTER VIEW [dbo].[V_REPORTLIST]
AS
SELECT     TOP (100) PERCENT dbo.REPORT.ID, dbo.REPORT.DATABASEID, dbo.REPORT.SVID, dbo.REPORT.REPORTNAME, dbo.REPORT.AUDODATE, dbo.REPORT.CATEGORY, 
                      dbo.REPORT.TYPE, dbo.REPORT.DISTRIBUTIONLEVEL, dbo.REPORT.RPTITLE, dbo.REPORT.ADDUSER, dbo.RPCATEGORY.NAME, 
                      dbo.REPORTGROUP.NAME AS distributiondesc, dbo.SOURCEVIEW.VIEWLEVEL, dbo.REPORT.DEFAULTFORMAT
FROM         dbo.REPORT LEFT OUTER JOIN
                      dbo.SOURCEVIEW ON dbo.REPORT.DATABASEID = dbo.SOURCEVIEW.DATABASEID AND dbo.REPORT.SVID = dbo.SOURCEVIEW.ID LEFT OUTER JOIN
                      dbo.RPCATEGORY ON dbo.REPORT.CATEGORY = dbo.RPCATEGORY.ID AND dbo.REPORT.DATABASEID = dbo.RPCATEGORY.DATABASEID LEFT OUTER JOIN
                      dbo.REPORTGROUP ON dbo.REPORT.DISTRIBUTIONLEVEL = dbo.REPORTGROUP.ID AND dbo.REPORT.DATABASEID = dbo.REPORTGROUP.DATABASEID
WHERE     (dbo.REPORT.ID IN
                          (SELECT     RPID
                            FROM          dbo.REPORTCOLUMN))
ORDER BY dbo.REPORT.ID DESC
GO
