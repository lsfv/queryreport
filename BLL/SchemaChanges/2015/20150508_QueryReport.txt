-- v1.0.0 - Cheong - 2015/05/07 - Add COLUMNTYPE and COLUMNCOMMENT fields to REPORTCOLUMN
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT

BEGIN TRANSACTION
GO
ALTER TABLE dbo.REPORTCOLUMN ADD
	COLUMNTYPE int NULL,
	COLUMNCOMMENT nvarchar(max) NULL,
	FORMULAFIELDID int NULL,
	HIDDEN bit NULL
GO
ALTER TABLE dbo.REPORTCOLUMN SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

BEGIN TRANSACTION
GO
UPDATE dbo.REPORTCOLUMN SET COLUMNTYPE = 1, COLUMNCOMMENT = N'', HIDDEN = 0
GO
COMMIT

BEGIN TRANSACTION
GO
ALTER TABLE dbo.REPORTCOLUMN ALTER COLUMN COLUMNTYPE int NOT NULL
GO
ALTER TABLE dbo.REPORTCOLUMN ALTER COLUMN COLUMNCOMMENT nvarchar(max) NOT NULL
GO
ALTER TABLE dbo.REPORTCOLUMN ALTER COLUMN HIDDEN int NOT NULL
GO
ALTER TABLE dbo.REPORTCOLUMN SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
GO
ALTER VIEW [dbo].[V_REPORT]
AS
SELECT
	r.SVID, rc.ID AS RCID, rc.RPID, rc.COLUMNNAME,
	rc.COLUMNFUNC, rc.CRITERIA1, rc.CRITERIA2, rc.CRITERIA3,
	rc.CRITERIA4, r.REPORTNAME, sv.SOURCEVIEWNAME, r.CATEGORY,
	COALESCE(NULLIF(rc.DISPLAYNAME, ''), NULLIF(svc.DISPLAYNAME, ''), NULLIF(svc.DEFAULTDISPLAYNAME, ''), svc.COLUMNNAME) DISPLAYNAME
FROM dbo.SOURCEVIEW sv
INNER JOIN dbo.SOURCEVIEWCOLUMN svc ON sv.ID = svc.SVID
INNER JOIN dbo.REPORT r ON sv.ID = r.SVID
INNER JOIN dbo.REPORTCOLUMN rc ON r.ID = rc.RPID AND svc.ID = rc.SOURCEVIEWCOLUMNID
GO

-- v1.0.0 - Cheong - 2015/05/07 - Add Formula related tables
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO
IF (SELECT COUNT(*) FROM sys.objects o WHERE o.name = 'FORMULAFIELD') = 0
BEGIN
	CREATE TABLE [dbo].[FORMULAFIELD] (
		[ID] [int] IDENTITY(1,1) NOT NULL,
		[FIELDNAME] [nvarchar](128) NOT NULL,
		[SVID] [int] NOT NULL,
		[RPID] [int] NULL,
		[FUNCTION] [int] NOT NULL,
		CONSTRAINT [PK_FORMULAFIELD] PRIMARY KEY CLUSTERED 
		(
			[ID] ASC
		) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT COUNT(*) FROM sys.objects o WHERE o.name = 'FORMULAPARAM') = 0
BEGIN
	CREATE TABLE [dbo].[FORMULAPARAM] (
		[ID] [int] IDENTITY(1,1) NOT NULL,
		[SVID] [int] NOT NULL,
		[RPID] [int] NULL,
		[PARAMTYPE] [int] NOT NULL,
		[VALUE1] [nvarchar](max) NULL,
		[FORMULAFIELDID] [int] NULL,
		CONSTRAINT [PK_FORMULAPARAM] PRIMARY KEY CLUSTERED 
		(
			[ID] ASC
		) WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO