-- v1.0.0 - Cheong - 2015/03/16 - Drop column NOSHOW and Add column SOURCETYPE to SOURCEVIEW
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
BEGIN TRANSACTION
IF (SELECT COUNT(*) FROM sys.objects o INNER JOIN sys.columns c ON o.object_id = c.object_id WHERE o.name = 'SOURCEVIEW' AND c.name = 'NOSHOW') = 1
BEGIN TRY
	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT [FK_SOURCEVIEW_SOURCEVIEW]
	ALTER TABLE [dbo].[REPORT] DROP CONSTRAINT [FK_REPORT_REPORT]
	ALTER TABLE [dbo].[WORDTEMPLATE] DROP CONSTRAINT [FK_WORDTEMPLATE_SOURCEVIEW]

	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT DF_SOURCEVIEW_NOSHOW
	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT DF_SOURCEVIEW_APPLICATIONID
	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT DF_SOURCEVIEW_AUTOTIME
	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT DF_SOURCEVIEW_DESC
	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT DF_SOURCEVIEW_TBLVIEWNAME
	ALTER TABLE [dbo].[SOURCEVIEW] DROP CONSTRAINT DF_SOURCEVIEW_VIEWLEVEL

	CREATE TABLE [dbo].[Tmp_SOURCEVIEW](
		[ID] [int] IDENTITY(1,1) NOT NULL,
		[SOURCEVIEWNAME] [nvarchar](50) NOT NULL,
		[DATABASEID] [int] NOT NULL,
		[SOURCETYPE] [int] NOT NULL,
		[TBLVIEWNAME] [nvarchar](128) NOT NULL,
		[AUDODATE] [datetime] NOT NULL,
		[VIEWLEVEL] [decimal](18, 2) NOT NULL,
		[DESC] [nvarchar](50) NULL,
		[LASTMODIFYDATE] [datetime] NULL,
		[LASTMODIFYUSER] [int] NULL,
	) ON [PRIMARY]

	ALTER TABLE [dbo].[Tmp_SOURCEVIEW] ADD  CONSTRAINT [DF_SOURCEVIEW_APPLICATIONID]  DEFAULT ((1)) FOR [DATABASEID]
	ALTER TABLE [dbo].[Tmp_SOURCEVIEW] ADD  CONSTRAINT [DF_SOURCEVIEW_SOURCETYPE]  DEFAULT ((0)) FOR [SOURCETYPE]
	ALTER TABLE [dbo].[Tmp_SOURCEVIEW] ADD  CONSTRAINT [DF_SOURCEVIEW_TBLVIEWNAME]  DEFAULT ('') FOR [TBLVIEWNAME]
	ALTER TABLE [dbo].[Tmp_SOURCEVIEW] ADD  CONSTRAINT [DF_SOURCEVIEW_AUTOTIME]  DEFAULT (getdate()) FOR [AUDODATE]
	ALTER TABLE [dbo].[Tmp_SOURCEVIEW] ADD  CONSTRAINT [DF_SOURCEVIEW_VIEWLEVEL]  DEFAULT ((1)) FOR [VIEWLEVEL]
	ALTER TABLE [dbo].[Tmp_SOURCEVIEW] ADD  CONSTRAINT [DF_SOURCEVIEW_DESC]  DEFAULT ('') FOR [DESC]

	IF EXISTS(SELECT * FROM [dbo].[SOURCEVIEW])
	BEGIN
		SET IDENTITY_INSERT [dbo].[Tmp_SOURCEVIEW]  ON

		INSERT INTO [dbo].[Tmp_SOURCEVIEW] ([ID],[SOURCEVIEWNAME],[DATABASEID],[SOURCETYPE],[TBLVIEWNAME],[AUDODATE],[VIEWLEVEL],[DESC],[LASTMODIFYDATE],[LASTMODIFYUSER])
			SELECT [ID],[SOURCEVIEWNAME],[DATABASEID],0,[TBLVIEWNAME],[AUDODATE],[VIEWLEVEL],[DESC],[LASTMODIFYDATE],[LASTMODIFYUSER] FROM [dbo].[SOURCEVIEW]

		SET IDENTITY_INSERT [dbo].[Tmp_SOURCEVIEW]  OFF
	END

	DROP TABLE [dbo].[SOURCEVIEW]

	EXECUTE sp_rename N'dbo.Tmp_SOURCEVIEW', N'SOURCEVIEW', 'OBJECT' 

	ALTER TABLE [dbo].[SOURCEVIEW] ADD  CONSTRAINT [PK_SOURCEVIEW] PRIMARY KEY CLUSTERED 
	(
		[ID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

	ALTER TABLE [dbo].[SOURCEVIEW]  WITH CHECK ADD  CONSTRAINT [FK_SOURCEVIEW_SOURCEVIEW] FOREIGN KEY([DATABASEID])
	REFERENCES [dbo].[DATABASE] ([ID])
	ON DELETE CASCADE

	ALTER TABLE [dbo].[SOURCEVIEW] CHECK CONSTRAINT [FK_SOURCEVIEW_SOURCEVIEW]

	ALTER TABLE [dbo].[REPORT]  WITH CHECK ADD  CONSTRAINT [FK_REPORT_REPORT] FOREIGN KEY([SVID])
	REFERENCES [dbo].[SOURCEVIEW] ([ID])
	ON DELETE CASCADE

	ALTER TABLE [dbo].[REPORT] CHECK CONSTRAINT [FK_REPORT_REPORT]

	ALTER TABLE [dbo].[WORDTEMPLATE]  WITH CHECK ADD  CONSTRAINT [FK_WORDTEMPLATE_SOURCEVIEW] FOREIGN KEY([VIEWID])
	REFERENCES [dbo].[SOURCEVIEW] ([ID])
	ON DELETE CASCADE

	ALTER TABLE [dbo].[WORDTEMPLATE] CHECK CONSTRAINT [FK_WORDTEMPLATE_SOURCEVIEW]

	UPDATE [dbo].[SOURCEVIEW] SET [SOURCETYPE] = 2 WHERE [TBLVIEWNAME] like 'sp%'
	COMMIT
END TRY
BEGIN CATCH
	ROLLBACK
END CATCH
